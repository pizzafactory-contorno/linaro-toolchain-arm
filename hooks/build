#!/bin/bash
set -eu

# (BASE_TAG)_(LINARO_GCC_VERSION)-(LINARO_GCC_RELEASE)-(LINARO_GCC_DATE)
BASE_TAG=${DOCKER_TAG%_*}
LINARO_ARGS=${DOCKER_TAG##*_}
LINARO_GCC_VERSION=${LINARO_ARGS%%-*}
RELEASE_DATE=${LINARO_ARGS#*-}
LINARO_GCC_RELEASE=${RELEASE_DATE%%-*}
LINARO_GCC_DATE=${RELEASE_DATE##*-}


if [ -z "${DOCKERFILE_PATH+UNDEF}" ]; then
    DOCKERFILE_PATH_ARG=""
else
    DOCKERFILE_PATH_ARG="-f $DOCKERFILE_PATH"
fi

docker build \
  --build-arg BASE_IMAGE=docker.io/pizzafactory0contorno/linux-kernel-build:$BASE_TAG \
  --build-arg LINARO_GCC_VERSION=${LINARO_GCC_VERSION} \
  --build-arg LINARO_GCC_RELEASE=${LINARO_GCC_RELEASE} \
  --build-arg LINARO_GCC_DATE=${LINARO_GCC_DATE} \
  ${DOCKERFILE_PATH_ARG} -t $IMAGE_NAME .

